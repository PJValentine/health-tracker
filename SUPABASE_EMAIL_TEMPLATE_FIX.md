# CORRECT Supabase Email Template for Password Reset

## The Problem

The current email template format is creating a session that logs users in instead of showing the password reset form.

---

## CORRECT Email Template

In **Supabase Dashboard** → **Authentication** → **Email Templates** → **Reset Password (Change)**

### Option 1: Use ConfirmationURL (RECOMMENDED)

Replace the reset link with:

```html
<h2>Reset Password</h2>
<p>Follow this link to reset your password:</p>
<p><a href="{{ .ConfirmationURL }}">Reset Password</a></p>
```

**Why this works:**
- `{{ .ConfirmationURL }}` is automatically generated by Supabase
- Contains the correct token format and type
- Automatically uses your configured Site URL
- No manual token construction needed

---

### Option 2: Manual Token Construction (If needed)

If you need to manually construct the URL:

```html
<h2>Reset Password</h2>
<p>Follow this link to reset your password:</p>
<p>
  <a href="{{ .SiteURL }}/reset-password?token={{ .TokenHash }}&type=recovery">
    Reset Password
  </a>
</p>
```

**IMPORTANT:** Note the closing `}}` after `{{ .TokenHash }}` - this was missing in your template!

**Your current template has:**
```
token={{ .TokenHash&type=recovery }}
         ^^^^^^^^^ WRONG - missing closing }}
```

**Should be:**
```
token={{ .TokenHash }}&type=recovery
         ^^^^^^^^^^^ CORRECT - properly closed
```

---

## Full Template Example

Here's a complete, working password reset email template:

```html
<h2>Reset Your Password</h2>

<p>Hi there,</p>

<p>We received a request to reset your password for your Health Tracker account.</p>

<p>Click the button below to reset your password:</p>

<p>
  <a href="{{ .ConfirmationURL }}"
     style="display: inline-block; padding: 12px 24px; background-color: #2D5F4F; color: white; text-decoration: none; border-radius: 6px; font-weight: 600;">
    Reset Password
  </a>
</p>

<p>If the button doesn't work, copy and paste this link into your browser:</p>
<p>{{ .ConfirmationURL }}</p>

<p>If you didn't request a password reset, you can safely ignore this email.</p>

<p>This link will expire in 1 hour.</p>

<p>Thanks,<br>Health Tracker Team</p>
```

---

## How to Update

### Step 1: Open Email Template Editor

1. Go to https://supabase.com/dashboard
2. Select your **health-tracker** project
3. Navigate to **Authentication** → **Email Templates**
4. Find **"Reset Password (Change)"** template
5. Click to edit

### Step 2: Replace the Link

Find the password reset link in the template (look for `<a href=...`).

**Current (WRONG):**
```html
<a href="{{ .SiteURL }}/reset-password?token={{ .TokenHash&type=recovery }}">
```

**Replace with (CORRECT):**
```html
<a href="{{ .ConfirmationURL }}">Reset Password</a>
```

Or if you must construct manually:
```html
<a href="{{ .SiteURL }}/reset-password?token={{ .TokenHash }}&type=recovery">
  Reset Password
</a>
```

### Step 3: Save

Click **Save** to apply changes.

### Step 4: Test

1. Request a new password reset
2. Check the email source/raw HTML
3. Verify the link looks like:
   ```
   https://health-tracker-nmlqo4xri-pjvalentines-projects.vercel.app/reset-password#access_token=xxx&refresh_token=yyy&type=recovery
   ```
   OR
   ```
   https://health-tracker-nmlqo4xri-pjvalentines-projects.vercel.app/reset-password?token=pkce_xxx&type=recovery
   ```

**NOT** like:
```
...?token={{ .TokenHash&type=recovery }}
                        ^ WRONG - template variable not rendered
```

---

## What Should Happen After Fix

### Correct Flow:

1. ✅ User requests password reset
2. ✅ Email arrives with properly formatted link
3. ✅ User clicks link → opens `/reset-password` page
4. ✅ Page shows "Set New Password" form
5. ✅ User enters new password and submits
6. ✅ Password is updated successfully
7. ✅ User is redirected to login page

### Current (Broken) Flow:

1. User requests password reset
2. Email has malformed link with template variables not rendered
3. User clicks link → page tries to validate invalid token
4. Error: "Invalid or expired reset link"

---

## Troubleshooting

### Issue: Template variables showing literally

**Symptom:** Email shows `{{ .TokenHash&type=recovery }}` as text

**Cause:** Template syntax error (missing closing `}}`)

**Fix:** Add the closing `}}`: `{{ .TokenHash }}`

---

### Issue: Link logs user in instead of showing form

**Symptom:** Clicking reset link logs you into the app

**Cause:** Using `{{ .ConfirmationURL }}` which creates a session immediately

**Fix:** This is actually correct behavior! After the link creates a session, you should:
1. See the password reset form (not be redirected away)
2. Be able to enter a new password
3. The session allows `updateUser()` to work

If you're being redirected away from the reset form, the issue is in the app code, not the email template.

---

### Issue: "Invalid redirect URL"

**Symptom:** Link fails with redirect error

**Cause:** Site URL not in Redirect URLs list

**Fix:** Add to **Redirect URLs** in Supabase dashboard:
```
https://health-tracker-nmlqo4xri-pjvalentines-projects.vercel.app/**
```

---

## Template Variables Reference

| Variable | Description | Example Output |
|----------|-------------|----------------|
| `{{ .ConfirmationURL }}` | Full reset URL with tokens | `https://example.com/reset-password#access_token=xxx&...` |
| `{{ .SiteURL }}` | Your configured site URL | `https://example.com` |
| `{{ .TokenHash }}` | Recovery token hash | `pkce_abc123def456...` |
| `{{ .Token }}` | Legacy token (use TokenHash instead) | `abc123...` |
| `{{ .Email }}` | User's email address | `user@example.com` |

**Best Practice:** Use `{{ .ConfirmationURL }}` to avoid manual URL construction errors.

---

## After Fixing Template

Once the template is fixed:

1. Request a **new** password reset (old emails won't work)
2. Open the email and check the link
3. Click the link
4. You should see the password reset form (not get logged in automatically)
5. Enter new password
6. Submit → Success!

If you still get logged in instead of seeing the form, that's a different issue with the app code that I'll fix separately.
